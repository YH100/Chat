<!DOCTYPE html>
<html>
<head>
    <title>YH Chat</title>

    <script src="{{ url_for('static', filename='js/crypto-js.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/aes.min.js') }}"></script>


    <script type="text/javascript" src="https://code.jquery.com/jquery-1.4.2.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>

    <script type="text/javascript">
        var userName = '{{ session['userName'] }}';
        var roomNumber = '{{ session['room'] }}';

        var CryptoJSAesJson = {
            parse: function(jsonStr) {
                var j = JSON.parse(jsonStr);
                var cipherParams = CryptoJS.lib.CipherParams.create({
                    ciphertext: CryptoJS.enc.Base64.parse(j.ct)
                });
                if (j.iv) cipherParams.iv = CryptoJS.enc.Hex.parse(j.iv);
                if (j.s) cipherParams.salt = CryptoJS.enc.Hex.parse(j.s);
                return cipherParams;
            },
            stringify: function(cipherParams) {
                var j = {
                    ct: cipherParams.ciphertext.toString(CryptoJS.enc.Base64)
                };
                if (cipherParams.iv) j.iv = cipherParams.iv.toString();
                if (cipherParams.salt) j.s = cipherParams.salt.toString();
                return JSON.stringify(j);
            }
        };
        var passphrase = 'fcf8afd67e96fa3366dd8eafec8bcace';
        var aesObject = {
            decrypt: function(data) {
                return JSON.parse(CryptoJS.AES.decrypt(data, passphrase, {
                    format: CryptoJSAesJson
                }).toString(CryptoJS.enc.Utf8));
            },
            encrypt: function(data) {
                return CryptoJS.AES.encrypt(JSON.stringify(data), passphrase, {
                    format: CryptoJSAesJson
                }).toString();
            }
        };

        window.onload = function() {
            var sendButton = document.getElementById("btnSend");
            sendButton.addEventListener("click", function() {
                var textElement = document.getElementById("textfield");
                var message = textElement.value;
                textElement.value = '';
                var encryptedMessage = aesObject.encrypt(message);
                socket.emit('text', {msg: encryptedMessage, userName: userName});
            });
        };

        function addNewMessage(message, userThatSentTheMessage) {
            encrypedMessage = message;
            message = aesObject.decrypt(encrypedMessage)
            message = userThatSentTheMessage + ": " + message;

            var chatsDiv = document.getElementById("chatlogs");

            var node = document.createElement("div");

            if (userThatSentTheMessage == userName)
                node.className = "chat self";
            else
                node.className = "chat friend";
            var innerDiv = document.createElement("div");
            innerDiv.className = "user-photo";
            var innerP = document.createElement("p");
            innerP.className = "chat-message";
            node.appendChild(innerDiv);
            node.appendChild(innerP);

            var textNode = document.createTextNode(message);
            innerP.appendChild(textNode);

            chatsDiv.appendChild(node);
        }


        function addNewAdminMessage(message) {
            var chatsDiv = document.getElementById("chatlogs");

            var innerP = document.createElement("p");
            innerP.className = "adminMessage";

            var textNode = document.createTextNode(message);
            innerP.appendChild(textNode);
            chatsDiv.appendChild(innerP);
        }

        function wrapText(text) {
            var words = text.split(" ");

            var result = "";
            for (var i = 0; i < words.length; i++) {
                result += words[i] + " ";
                if (i % 5 == 0)
                    result += "\n";
            }
            return result;
        }

    </script>

    <script type="text/javascript" charset="utf-8">
        var socket;
        $(document).ready(function(){
            debugger;
            socket = io.connect('http://' + document.domain + ':' + location.port + '/chat');
            socket.on('connect', function() {
                socket.emit('joined', {});
            });
            socket.on('status', function(data) {
                addNewAdminMessage(data.msg);


                // $('#chat').val($('#chat').val() + '<' + data.msg + '>\n');
                // $('#chat').scrollTop($('#chat')[0].scrollHeight);
            });
            socket.on('message', function(data) {
                addNewMessage(data.msg, data.userThatSentTheMessage);
            });
        });
        function leave_room() {
            socket.emit('left', {}, function() {
                socket.disconnect();

                // go back to the login page
                window.location.href = "{{ url_for('login_root') }}";
            });
        }







    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            font-family: tahoma, sans-serif;
            box-sizing: border-box;
        }

        body {
            background: #1ddced;
        }

        .chatbox {
            width: 500px;
            min-width: 390px;
            height: 600px;
            background: #fff;
            padding: 25px;
            margin: 20px auto;
            box-shadow: 0 3px #ccc;
        }

        .chatlogs {
            padding: 10px;
            width: 100%;
            height: 450px;
            overflow-x: hidden;
            overflow-y: scroll;
        }

        .chatlogs::-webkit-scrollbar {
            width: 10px;
        }

        .chatlogs::-webkit-scrollbar-thumb {
            border-radius: 5px;
            background: rgba(0,0,0,.1);
        }

        .chat {
            display: flex;
            flex-flow: row wrap;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .adminMessage {
            border-radius: 25px;
            border: 2px solid #6699ff;
            padding: 20px;
            width: 400px;
            height: 2px;
            text-align: center;
            margin-bottom: 10px;
        }

        .chat .user-photo {
            width: 60px;
            height: 60px;
            background: #ccc;
            border-radius: 50%;
            overflow:hidden;
        }

        .chat .user-photo img{
            width: 100%

        }

        .chat .chat-message {
            width: 80%;
            padding: 15px;
            margin: 5px 10px 0;
            border-radius: 10px;
            color: #fff;
            font-size: 20px;
        }

        .friend .chat-message {
            background: #1adda4;
        }

        .self .chat-message {
            background: #1ddced;
            order: -1;
        }

        .chat-form {
            margin-top: 20px;
            display: flex;
            align-items: flex-start;
        }

        .chat-form input {
            background: #fbfbfb;
            width: 75%;
            height: 50px;
            border: 2px solid #eee;
            border-radius: 3px;
            resize: none;
            padding: 10px;
            font-size: 18px;
            color: #333;
        }

        .chat-form textarea:focus {
            background: #fff;
        }

        .chat-form button {
            background: #1ddced;
            padding: 5px 15px;
            font-size: 30px;
            color: #fff;
            border: none;
            margin: 0 10px;
            border-radius: 3px;
            box-shadow: 0 3px 0 #0eb2c1;
            cursor: pointer;

            -webkit-transaction: background .2s ease;
            -moz-transaction: backgroud .2s ease;
            -o-transaction: backgroud .2s ease;
        }

        .chat-form button:hover {
            background: #13c8d9;
        }

.button {
  border-radius: 4px;
  background-color: #f4511e;
  border: none;
  color: #FFFF;
  text-align: center;
  font-size: 28px;
  padding: 20px;
  width: 300px;
  transition: all 0.5s;
  cursor: pointer;
  margin: 5px;
}

.button span {
  cursor: pointer;
  display: inline-block;
  position: relative;
  transition: 0.5s;
}

.button span:after {
  content: '\00bb';
  position: absolute;
  opacity: 0;
  top: 0;
  right: -20px;
  transition: 0.5s;
}

.button:hover span {
  padding-right: 25px;
}

.button:hover span:after {
  opacity: 1;
  right: 0;
}



    </style>
</head>
<body>
<center>
    <h1>Welcome: {{ session['userName'] }}</h1>
    <br/>
    <h1>Room Name: {{ session['room'] }}</h1>
</center>
<button class="button"><span>Sport</span></button>
<br>
<button class="button"><span>Computer games</span></button>
<br>
<button class="button"><span>Food - cooking</span></button>
<br>
<button class="button"><span>Theater</span></button>
<div class="chatbox">

    <div id="chatlogs" class="chatlogs">

    </div>
    <!-- <form action="http://localhost:5000/message" class="form" method="post"> -->
    <form action="" class="form" method="post" onSubmit="return false">
        <div class="chat-form">
            <input id="textfield" placeholder="Write your message here" name="messagefield" type="text">
            <button id="btnSend">Send</button>
            <input type="hidden" value="foo" name="user_id"/>
        </div>
    </form>
</div>


</body>
</html>
